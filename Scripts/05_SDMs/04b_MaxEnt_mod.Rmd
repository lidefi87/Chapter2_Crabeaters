---
title: "Maxent trained with ACCESS-OM2-01 outputs"
author: "Denisse Fierro Arcos"
date: "2023-11-02"
output: 
  github_document:
    toc: true
    html_preview: false
---
# Maxent via SDMtune

MaxEnt is one of the most widely used species distribution model algorithm. 

In this project, we will use MaxEnt as one of the models to be considered in our Species Distribution Model ensemble to estimate the distribution of crabeater seals in the recent past.  
  
## Loading libraries

```{r, message=F, warning=F}
library(tidyverse)
library(SDMtune)
library(stars)
library(sf)
library(cmocean)
library(cowplot)
source("useful_functions.R")
```

## Setting up notebook

Selecting an output folder for GAM results exists and getting a list of data files.  
  
```{r}
#Location of folder for outputs
out_folder <- "../../SDM_outputs/Maxent/Mod_full"
#If folder does not exist, create one
if(!dir.exists(out_folder)){
  dir.create(out_folder, recursive = T)
}

#Get path to files containing data
file_list <- list.files("../../Environmental_Data/", pattern = "Indian", full.names = T)
```
   
### Loading mean environmental conditions from ACCESS-OM2-01

This dataset includes the mean environmental conditions per month (November and December) over the entire period of study (1981 to 2013).

```{r}
mean_model <- read_csv("../../Environmental_Data/ACCESS-OM2-01/All_values_month_ACCESS-OM2-01_env_vars.csv") %>% 
  mutate(month = as.factor(month)) %>% 
  #Drop variables with high multicollinearity
  select(!c(freez_pot_Wm2, bottom_sal_psu, SIT_m))

#List of categorical variables
cat_vars <- "month"

mean_model_baked <- prep_pred(mean_model, cat_vars)
```
  
## Loading layers for plotting
We will extract this layer from the `rnaturalearth` package. We will then reproject this layer to South Polar Stereographic (`EPSG 3976`).  
  
```{r}
#Loading layer
antarctica <- rnaturalearth::ne_countries(continent = "Antarctica",
                                          returnclass = "sf") %>% 
  #Transforming to South Polar Stereographic
  st_transform(3976)
```
  
## Loading environmental data from ACCESS-OM2-01 and setting up variables

We will use the datasets created in the notebook `02_Merging_background_presence_data.Rmd` located within the `Scripts/05_SDMs` folder. These datasets include the crabeater seal observations, background points, and environmental data.  
  
We will also define categorical and continuous explanatory variables.  
  
### Environmental variables matching observations 
First, we will look only at the variables with no multicollinearity. This means that sea surface temperature (`SST`) is excluded even though this variable is available in the observational dataset.  
  
The variable `month` will be included as an ordinal factor in our analysis.  
  
```{r}
#Loading data
mod_data <- read_csv(str_subset(file_list, "model")) %>% 
  #Setting month as factor and ordered factor
  mutate(month = as.factor(month)) %>% 
  #Drop variables with high multicollinearity
  select(!c(freez_pot_Wm2, bottom_sal_psu, SIT_m))
```
  
#### Splitting data into testing and training
The `prep_data` function in the `useful_functions` script will be used to split our data and to apply all necessary transformations.
We will then transform the data into SWD ("samples with data") format, which is the required format for inputs used in the `SDMtune` library.   
   
```{r}
#Getting training data
mod <- prep_data(mod_data, cat_vars, split = F)

#Applying SWD format to model data
model_data <- mod %>% 
  select(!year) %>% 
  sdm_format() %>% 
  trainValTest(test = 0.25, only_presence = T, seed = 42)
```

#### Modelling
MaxEnt has different feature classes (`fc`, otherwise known as restrictions) available for modelling. These `fc` include:  
- `l` - lineal,  
- `q` - quadratic,  
- `p` - product,  
- `t` - threshold,  
- `h` - hinge  
and any possible combination of these 5 features.  
  
Regularisation (`reg`) refers to *L1 regularisation* also known as *Lasso (Least Absolute Shrinkage and Selection Operator) regression*. This involves adding an absolute value of magnitude as a penalty term to the loss function. It is used to prevent overfitting. In MaxEnt a `reg` value lower than 1 results in a outputs that fit closer to presence data. The risk of using values that are too small is a model that overfits and therefore does not generalised well. While, `reg` values larger than 1 result in less localised predictions, producing smoother or more diffuse distributions.  
  
Here, we use the `SDMtune` library to test various combinations of regularisation and feature classes values. We will identify the "best model" using the are  `AUC`

getTunableArgs(default_model) = to check arguments that can be changed in a model.
  
```{r}
#Train model
default_model <- train(method = "Maxent", data = model_data[[1]])

# Define the hyperparameters to test
hyp_parm <- list(reg = seq(0.5, 5, 0.5),
                 #Feature classes
                 fc = c("lq", "lh", "lqp", "lqph", "lqpht"),
                 #Number of iterations
                 iter = c(500, 1000, 1500))

# Test all the possible combinations with gridSearch
gs_mod <- gridSearch(default_model, hypers = hyp_parm, metric = "auc", 
                          test = model_data[[2]])

#Check best performing models based on AUC
gs_mod@results %>% 
  #Adding index as column to identify best model easily
  rownames_to_column("index") %>% 
  #Arranging results by AUC from testing data (descending order)
  arrange(-test_AUC, diff_AUC) %>% 
  #Showing only the top 5 models
  head(n = 5)

#Best model based on test AUC and smallest AUC difference between train and test
best_max_mod <- gs_mod@models[[110]]

best_max_mod %>% 
  readRDS(file.path(out_folder, "initial_Maxent_model/best_maxent_model_grid.rds"))
```
  
## Variable importance
We can check the contribution of each environmental variable to model performance.  
  
```{r}
var_imp_best <- varImp(best_max_mod) 
var_imp_best %>% 
  plotVarImp()
```
  
We can see that `SST` is by far the most important variable in this model. Almost twice as important as `SIC`, which was identified as the second most important variable.  
  
## Jacknife tests
We can now check which environmental variables contributed the most to the Maxent model. This is important because we know both `SIC` and `SST` are highly correlated and this will help us decide which variable to keep in the final model.  
  
```{r}
jk_mod <- doJk(best_max_mod, metric = "auc", test = model_data[[2]])
jk_mod
```
  
### Plotting Jacknife results
We can plot this information so we can compare the importance across all variables included in the model. We can plot this information based on the training dataset.  

```{r}
plotJk(jk_mod, type = "train", ref = auc(best_max_mod))
```
  
We can see that `SST` when used by itself has the highest accuracy gain, followed by `SIC`. When `SST` was removed, it resulted in the largest decrease in AUC followed by a removal of `SIC`. Now, we will consider the importance of variables calculated from the testing dataset.  
  
On the other hand, the slope of the sea floor (`bottom_slope_deg`) and the `month` of the year are the two variables with the lowest contribution to accuracy. Their removal almost has no effect on model performance.  
  
```{r}
plotJk(jk_mod, type = "test", ref = auc(best_max_mod, 
       test = model_data[[2]]))
```
  
The results are slightly different from the testing dataset perspective. Here, we see that the use of `SIC` improved the model accuracy the most, closely followed by `SST`. 

The slope of the sea floor (`bottom_slope_deg`) and the `month` of the year are also the two variables with the lowest contribution to accuracy. Their removal almost has no effect on model performance. 
  
Based on this information, we could simplify the model by removing the `bottom_slope_deg` and `month` from the model. Additionally, we can test the model performance without `SST` since this variable is highly correlated to `SIC` and its removal leads to slightly less accuracy loss than removing `SIC`.   
  
## Variable correlation (multicollinearity)
Before removing any variables, we can confirm if multicollinearity is present in our data.  
  
```{r}
plotCor(model_data[[1]], method = "spearman", cor_th = 0.75)
```
  
We can confirm that `SST` and `SIC` are highly correlated. Additionally, distance to the continental shelf (`dist_shelf_km`) and `depth`, and long-term presence of pack ice (`lt_pack_ice`) and distance to the sea ice edge (`dist_ice_edge_km`) are highly correlated. These last two pairs of correlations were not detected by our exploratory data analysis.    
  
We will now check if we can remove some of the lowest contributing variables, which include some of the highly correlated variables highlighted above.  
  
## AUC curves
We will calculate AUC curves, so we can compare to the simplified models we will test.  
  
```{r}
plotROC(best_max_mod, test = model_data[[2]])
```

## True Skill Statistic (TSS)

```{r}
tss(best_max_mod)
```
## Model report
Before moving onto testing a new model, we will save a report with the information shown above.  
  
```{r}
modelReport(best_max_mod, type = "cloglog", folder = file.path(out_folder, "initial_Maxent_model"),
            test = model_data[[2]], response_curves = T, only_presence = T,
            jk = T)
```
  
## Reducing model variables
We will now remove the variables that contributed the least to the model. The code below will remove one variable at a time, train the model and recalculate AUC.  
  
```{r}
simple_model <- reduceVar(best_max_mod, metric = "auc", test = model_data[[2]],
                          th = 5, permut = 10, use_jk = T)

simple_model
```
  
We have identified two variables that we can remove without affecting the predictive performance of the model: `month` and the slope of the seafloor (`bottom_slope_deg`). However, we still have some variables that were highly correlated: distance to continental shelf (`dist_shelf_km`) and depth (`depth_m`), long-term pack ice presence (`lt_pack_ice`) and distance to the sea ice edge (`dist_ice_edge_km`), and sea surface temperature (`SST_degC`) and `SIC`.   
  
As explained in previous notebooks, multicollinearity negatively impacts the predictive ability of Maxent. Based on the jacknife tests performed on the testing dataset, we will remove depth (`depth_m`) as the model performance virtually has no difference when it is removed. Then, we will test the impact on performance of removing either long-term pack ice presence (`lt_pack_ice`) or distance to the sea ice edge (`dist_ice_edge_km`) as the impact of excluding them from the model was very similar (see jacknife tests). Finally, we will check the effect of excluding either sea surface temperature (`SST_degC`) or `SIC`.  All other parameters in the model will remain the same, and we will calculate AUC for each new model to decide which model is best.  
  
## Removing highly correlated variables
First, we will start by removing the two variables identified as not significantly contributing to the model `month` and the slope of the seafloor (`bottom_slope_deg`), as well as `depth_m`. Then, we will remove long-term pack ice presence (`lt_pack_ice`) and calculate AUC values and ROC curves.  
  
```{r}
#Dataset for training and testing - excluding low contribution variable, depth and long-term pack ice presence
model_data_nodepth_noltice <- mod %>% 
  select(!c(year, month, bottom_slope_deg, depth_m, lt_pack_ice)) %>% 
  sdm_format() %>% 
  trainValTest(test = 0.25, only_presence = T, seed = 42)

#Train model
simple_model_nodepth_noltice <- train(method = "Maxent", fc = "lqpht", reg = 1, iter = 1500,
                               data = model_data_nodepth_noltice[[1]])

#Plot ROC curves
plotROC(simple_model_nodepth_noltice, test = model_data_nodepth_noltice[[2]])
```
  
For reference, the AUC from the original model we are testing against was `0.712` (against testing dataset). By removing long-term pack ice presence (`lt_pack_ice`), the AUC declined slightly to `0.701` when using the testing data. Now we will remove `dist_ice_edge_km` and compare its performance.  
  
```{r}
#Dataset for training and testing - excluding low contribution variable, depth and distance to sea ice edge
model_data_nodepth_noedge <- mod %>% 
  select(!c(year, month, bottom_slope_deg, depth_m, dist_ice_edge_km)) %>% 
  sdm_format() %>% 
  trainValTest(test = 0.25, only_presence = T, seed = 42)

#Train model
simple_model_nosdepth_noedge <- train(method = "Maxent", fc = "lqpht", reg = 1, iter = 1500,
                               data = model_data_nodepth_noedge[[1]])

#Plot ROC curves
plotROC(simple_model_nosdepth_noedge, test = model_data_nodepth_noedge[[2]])
```  
  
Removing `dist_ice_edge_km` results in a slightly better model performance, so we will exclude it from the model and test the effect on performance of removing either sea surface temperature (`SST_degC`) or `SIC`.  
    
Given that `SST` was identified as the variable contribution the most to model performance, it is likely that their exclusion will result in a lower performing model. Let's remove this variable first.  
  
```{r}
#Dataset for training and testing - excluding low contribution variable, depth and distance to sea ice edge
model_data_noSST <- mod %>% 
  select(!c(year, month, bottom_slope_deg, depth_m, dist_ice_edge_km, SST_degC)) %>% 
  sdm_format() %>% 
  trainValTest(test = 0.25, only_presence = T, seed = 42)

#Train model
simple_model_noSST <- train(method = "Maxent", fc = "lqpht", reg = 1, iter = 1500,
                               data = model_data_noSST[[1]])

#Plot ROC curves
plotROC(simple_model_noSST, test = model_data_noSST[[2]])
```  
  
For reference, the AUC from the original model we are testing against was `0.712` (against testing dataset). Now, we will remove `SIC`.  
  
```{r}
#Dataset for training and testing - excluding low contribution variable, depth and distance to sea ice edge
model_data_noSIC <- mod %>% 
  select(!c(year, month, bottom_slope_deg, depth_m, dist_ice_edge_km, SIC)) %>% 
  sdm_format() %>% 
  trainValTest(test = 0.25, only_presence = T, seed = 42)

#Train model
simple_model_noSIC <- train(method = "Maxent", fc = "lqpht", reg = 1, iter = 1500,
                               data = model_data_noSIC[[1]])

#Plot ROC curves
plotROC(simple_model_noSIC, test = model_data_noSIC[[2]])
```  
  
As expected, removing `SST` had a larger impact on the model performance, so we will remove `SIC` instead. Now we can check our dataset for multicollinearity.  
  
```{r}
plotCor(model_data_noSIC[[1]], method = "spearman", cor_th = 0.75)
```
  
No multicollinearity was detected, now we can check if the model hyperparameters need updating with the reduced number of environmental variables.  

## Training model with reduced variables
  
```{r}
#Train model
default_model <- train(method = "Maxent", data = model_data_noSIC[[1]])

# Test all the possible hyper parameter combinations with gridSearch
gs_mod <- gridSearch(default_model, hypers = hyp_parm, metric = "auc", 
                     test = model_data_noSIC[[2]])

#Check best performing models based on AUC
gs_mod@results %>% 
  #Adding index as column to identify best model easily
  rownames_to_column("index") %>% 
  #Arranging results by AUC from testing data (descending order)
  arrange(-test_AUC, diff_AUC) %>% 
  #Showing only the top 5 models
  head(n = 5)

#Best model based on test AUC and smallest AUC difference between train and test
best_max_mod <- gs_mod@models[[104]]

best_max_mod %>% 
  saveRDS(file.path(out_folder, "reduced_Maxent_model/best_red_maxent_model.rds"))
```
  
We can see that the values of the feature classes (`fc`) and regularisation (`reg`) hyper parameters in the best performing model changed when we reduced the environmental variables used as inputs. Now, we will produce a report on the best performing model (based on AUC calculated from the testing dataset), which contains the same tests applied in our original model.
  
## Model report

```{r}
out <- file.path(out_folder, "reduced_Maxent_model")
#If folder does not exist, create one
if(!dir.exists(out_folder)){
  dir.create(out_folder, recursive = T)
}

#Produce report
modelReport(best_max_mod, type = "cloglog", folder = out, test = model_data_noSIC[[2]], 
            response_curves = T, only_presence = T, jk = T)
```
  
Based on the report, the most important variable continues to be `SST`, closely followed by salinity at the surface (`SSS_psu`) and the long-term presence of pack sea ice (`lt_pack_ice`). While, the least important variable is `vel_lon_bottom_msec`. We will check if the removing the least important variables in the model affects its predictive performance.  
  
```{r}
simple_model <- reduceVar(best_max_mod, metric = "auc", test = model_data_noSIC[[2]],
                          th = 5, permut = 10, use_jk = T)

simple_model
```
  
No more variables were removed, so we can now predict the crabeaters distribution using the simplified model we produced the report for.  
  
## Predictions
  
```{r}
pred_mod <- mean_model_baked %>% 
  drop_na() %>% 
  mutate(pred = as.vector(predict(best_max_mod,
                                  data = mean_model_baked,
                                  type = "cloglog")))

pred_mod_ras <- pred_mod %>% 
  #Select relevant variables only
  select(xt_ocean, yt_ocean, pred, month) %>% 
  right_join(mean_model_baked %>%
  #Select relevant variables only
  select(xt_ocean, yt_ocean, month)) %>% 
  #Set dimensions
  st_as_stars(dims = c("xt_ocean", "yt_ocean", "month")) %>% 
  #Ensuring month dimension is shown correctly
  st_set_dimensions("month", values = c(11, 12)) %>%
  #Set CRS
  st_set_crs(4326) %>% 
  #Transform to South Pole stereographic
  st_transform(crs = st_crs(3976))

#Saving outputs
#Data frame
pred_mod %>% 
  write_csv(file.path(out_folder, "reduced_Maxent_model/mean_pred_ACCESS.csv"))
#Saving as R dataset so it can be easily open with readRDS
pred_mod_ras %>% 
  saveRDS(file.path(out_folder, "reduced_Maxent_model/mean_pred_ACCESS.rds"))
```

### Plotting predictions

```{r}
#Plotting November distribution
#Prepping data
nov <- pred_mod_ras %>% 
  slice(index = 1, along = "month") 

#Plotting
nov_plot <- ggplot()+
  geom_stars(data = nov)+
  geom_sf(data = antarctica)+
  lims(x = c(0, 5200000))+
  #Set colour palette
  scale_fill_cmocean(name = "haline", direction = -1, 
                     guide = guide_colorbar(barwidth = 1, barheight = 10, 
                                            ticks = FALSE, nbin = 1000, 
                                            frame.colour = "black"), 
                     limits = c(0, 1)) +
  theme_linedraw() +
  theme(panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(), 
        legend.position = "none",
        plot.title = element_text(hjust = 0.5)) +
  labs(title = "November",
       x = "Longitude",
       y = "Latitude")

dec <- pred_mod_ras %>% 
  slice(index = 2, along = "month") 

dec_plot <- ggplot() +
  geom_stars(data = dec) +
  geom_sf(data = antarctica)+
  lims(x = c(0, 5200000))+
  scale_fill_cmocean(name = "haline", direction = -1, 
                     guide = guide_colorbar(barwidth = 1, barheight = 10, 
                                            ticks = FALSE, nbin = 1000, 
                                            frame.colour = "black"), 
                     limits = c(0, 1)) +
  theme_linedraw() +
  theme(panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(), 
        plot.title = element_text(hjust = 0.5)) +
  labs(title = "December",
       x = "Longitude",
       y = " ",
       fill = "Probability")

#Get legend
legend <- get_legend(dec_plot)

#Remove legend from December plot
dec_plot <- dec_plot + theme(legend.position = 'none')

#Plotting together
plot_match_obs <- plot_grid(nov_plot, dec_plot, legend, ncol = 3, nrow = 1,
                            rel_widths = c(1, 1, 0.3))

#Add title
title <- ggdraw()+
  draw_label("Mean crabeater seal distribution\n(ACCESS-OM2-01)",
             fontface = "bold", hjust = 0.5)+
  theme(plot.margin = margin(0, 0, 0, 0))

#Putting everything together
final <- plot_grid(title, plot_match_obs, ncol = 1, rel_heights = c(0.1, 1))

#Saving graph
ggsave(file.path(out_folder, "map_mean_pred_ACCESS.png"), 
       plot = final, device = "png", bg = "white", width = 8.75, height = 7)

```

