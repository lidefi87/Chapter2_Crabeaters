---
title: "Generalised Additive Model"
author: "Denisse Fierro Arcos"
date: "2023-09-22"
output: 
  github_document:
    toc: true
    html_preview: false
---

# Generalised Additive Model (GAM)

GAMs are commonly used in species distribution modelling because of their flexibility. GAMs use smoothing functions to capture non-linear relationships between the dependent variable and the predictors (i.e., independent variables).

In this project, we will use GAMs as one of the models to be considered in our Species Distribution Model ensemble to estimate the distribution of crabeater seals in the recent past.  
  
## Loading libraries

```{r, message=F, warning=FALSE}
library(tidyverse)
# library(tidymodels)
# library(caret)
library(mgcv)
source("useful_functions.R")
```


## Setting up

Selecting an output folder for GAM results exists and getting a list of data files.  
  
```{r}
#Location of folder for outputs
out_folder <- "../../SDM_outputs/GAM"
#If folder does not exist, create one
if(!dir.exists(out_folder)){
  dir.create(out_folder, recursive = T)
}

#Get path to files containing data
file_list <- list.files("../../Environmental_Data/", pattern = "Indian", full.names = T)

```
  
## Loading data and setting up variables

We will use the datasets created in the notebook `02_Merging_background_presence_data.Rmd` located within the `Scripts/05_SDMs` folder. These datasets include the crabeater seal observations, background points, and environmental data.  
  
We will also define categorical and continuous explanatory variables.  
    
```{r}
#Loading data
mod_match_obs <- read_csv(str_subset(file_list, "match")) %>% 
  #Setting month as ordered factor
  mutate(month = factor(month, ordered = T))

#List of categorical variables
cat_vars <- "month"

#List of uncorrelated covariates
covars_low_vif <- str_subset(names(mod_match_obs), "presence|SST|_ocean", negate = T)
covars_match_obs <- str_subset(names(mod_match_obs), "presence|_ocean", negate = T)
```
  
## Dealing with formulas
```{r}
#From vars.R script
# environmental covariates - non categorical
env_non_cat <- covars_low_vif[!covars_low_vif %in% cat_vars]

# building GAM formulas - Most complex model
gam_formula <- presence ~ month + s(year) + s(year, by = month) + s(bottom_slope_deg) + s(dist_shelf_km) + s(dist_coast_km) + s(depth_m) + s(SIC) + s(SIC, by = month) + s(lt_pack_ice) + s(lt_pack_ice, by = month) + s(dist_ice_edge_km) + s(dist_ice_edge_km, by = month)


# gam_formula <- paste("presence ~", paste(paste(paste0("s(", env_non_cat, ")"), collapse = " + "),
#                                      paste0(cat_vars, collapse = " + "), sep = " + "))

# gam_forms <- vector()
# for(i in env_non_cat){
#   f1 <- paste("presence ~", paste(paste(paste0("s(", env_non_cat, ")"), collapse = " + ")))
#   gam_forms <- append(gam_forms, f1)
#   comb <- env_non_cat
#   while(length(comb) > 1){
#     for(j in c(2:length(comb))){
#     comb_loop <- comb[-j]
#     f2 <- paste("presence ~", paste(paste(paste0("s(", comb_loop, ")"), collapse = " + ")))
#     gam_forms <- append(gam_forms, f2)}
#     comb <- comb[-2]
#   }
#   env_non_cat <- env_non_cat[!env_non_cat %in% i]
# }
# 
# rm(f1, f2, comb_loop, comb, i, j)

```
  
## Splitting data into testing and training
```{r}
split_data <- function(da, cat_vars){
  #Setting seed for reproducible results
  set.seed(42)
  #Dividing dataset (training and testing)
  split <- initial_split(da, prop = 0.75, strata = "presence") 
  train <- training(split) %>% 
    arrange(desc(presence))
  test <- testing(split) %>% 
    arrange(desc(presence))
  #Creating a list with training and testing data
  out <- list(train = train,
              test = test)
  return(out)
}

species <- "Crabeater seals"
#Getting training data
mod_match_obs_split <- prep_data(mod_match_obs, cat_vars)

# rec <- recipe(presence ~ ., mod_match_obs_split$train) %>%
#     #Coordinates (xt_ocean and yt_ocean) are not pre-processed
#     add_role(xt_ocean, yt_ocean, new_role = "coords") %>% 
#     add_role(cat_vars, new_role = "categorical") %>% 
#     #Scaled and center all predictors - exclude coordinates
#     step_center(all_predictors(), -c(has_role("coords"), has_role("categorical"))) %>% 
#     step_scale(all_predictors(), -c(has_role("coords"), has_role("categorical"))) %>% 
#     step_integer(has_role("categorical"))
    
#Applying recipe to training data
# baked_train <- prep(rec, training = mod_match_obs_split$train) %>% 
#     bake(new_data = mod_match_obs_split$train)

#Matching numerical categories with years
#table(baked_train$year, mod_match_obs_split$train$year)
# table(baked_train$month, mod_match_obs_split$train$month)

#Selecting model data
model_data <- mod_match_obs_split$baked_train %>%
  select(all_of(covars_low_vif) | "presence")

```
  
## Modelling
  
```{r}
set.seed(42)
#Calculating downweights
weight <- model_data %>% 
  count(presence) %>% 
  pivot_wider(names_from = presence, values_from = n) %>% 
  mutate(weight = `1`/`0`) %>% 
  pull(weight)

weights <- model_data %>% 
  mutate(weight = case_when(presence == 0 ~ weight,
                              T ~ presence)) %>% 
  pull(weight) #%>% 
  # importance_weights()
  
mod_gam <- gam(formula = as.formula(gam_formula),
    data = model_data,
    family = binomial(link = "cloglog"),
    weights = weights,
    method = "REML", select = T)

summary(mod_gam)

```
  
Removing non-significant categorical variable `year` and `bottom_slope_deg` because they are non-significant. The effect of `bottom_slope_deg` has been reduced to near zero (`edf` < 0.001) The distance to the shelf (`dist_shelf_km`) and distance to the coast (`dist_coast_km`) are non-significant, but 
  
```{r}

gam_formula2 <- "presence ~ s(dist_shelf_km) + s(dist_coast_km) + s(depth_m) + s(SIC) + s(lt_pack_ice) + s(dist_ice_edge_km) + month"

mod_gam2 <- gam(formula = as.formula(gam_formula2),
    data = model_data,
    family = binomial(link = "cloglog"),
    weights = weights,
    method = "REML", select = T)

summary(mod_gam2)


```







```{r}
ggpairs(model_data, columns = c(10, 1:9))
```




```{r}
gam_mod <- gen_additive_mod(mode = "regression", select_features = T,
                            adjust_deg_free = 5) %>%
  set_engine("mgcv", family = binomial(link = "cloglog"), method = "REML")

gam_fit <- gam_mod %>% 
  fit(as.formula(gam_forms[1]), data = model_data)

tidy(gam_fit)
```


```{r}
gam_mod <- gen_additive_mod(mode = "regression", select_features = T) %>%#,
                            # adjust_deg_free = 1) %>% 
  set_engine("mgcv", family = binomial(link = "cloglog"), method = "REML")

gam_fit <- gam_mod %>% 
  fit(as.formula(gam_forms[1]), data = model_data)

tidy(gam_fit)
```


  
  
```{r}
library(parsnip)
library(tune)
library(dials)

#Creating recipe - steps to be followed when pre-processing data
recipe_bg <- recipe(presence ~ ., mod_match_obs_split$train) %>%
  #Coordinates (xt_ocean and yt_ocean) are not pre-processed
  add_role(xt_ocean, yt_ocean, new_role = "no_prepro") %>% 
  add_role(cat_vars, new_role = "no_prepro") %>% 
  #Scaled and center all predictors - exclude coordinates
  step_center(all_predictors(), -has_role("no_prepro")) %>% 
  step_scale(all_predictors(), -has_role("no_prepro")) %>% 
  prep()

prepro <- recipe_bg %>% 
  bake(mod_match_obs_split$train)

test_prep <- recipe_bg %>% 
  bake(mod_match_obs_split$test)

folds <- vfold_cv(prepro, v = 5)

gam_params <- parameters(adjust_deg_free())

# cv <- trainControl(method = "repeatedcv", number = 10, repeats = 5)
# hyper_grid <- expand.grid(df = 2:5)#formula = gam_forms$gam_forms)
gam_grid <- grid_max_entropy(gam_params, size = 5)

gam <- gen_additive_mod(mode = "regression", 
                        adjust_deg_free = tune()) %>% 
  set_engine("mgcv") 

gam_wf <- workflow() %>% 
  add_variables(outcomes = presence, predictors = env_non_cat) %>% 
  add_model(gam, formula = as.formula(gam_forms[1,])) #%>% 
  # add_recipe(formula = as.formula(gam_forms[1,]))
  # fit(as.formula(gam_forms[1,]), data = mod_match_obs_split$train)

spline_gam <- tune_grid(model = gam, gam_wf,
                        resamples = folds, 
                        grid = gam_grid, metrics = metric_set(mae, rmse, rsq))

show_best(spline_gam, metric = "rmse") 

params <- select_best(spline_gam, metric = "rmse") %>% 
  select(adjust_deg_free)#, maximize = F)

gam_end <- gam %>% 
  finalize_model(parameters = params)

gam_end %>% 
  fit(formula = as.formula(gam_forms[1,]),
      data = prepro) %>% 
  predict(new_data = test_prep) %>% 
  bind_cols(mod_match_obs_split$test) %>% View()

# gam_fit <- train(recipe_bg, data = mod_match_obs_split$train, 
#                  method = "gam", trControl = cv, tuneGrid = hyper_grid,
#                  metric = "RMSE")
```

  
## Loading environmental data
  
```{r}
#Env data to predict
evaluation <- read_csv("../../Environmental_Data/ACCESS-OM2-01/All_values_ACCESS-OM2-01_env_vars.csv") %>% 
  select(any_of(names(mod_match_obs_split$baked_train)))
```





```{r}
library(parsnip)
library(workflows)
library(tidymodels)

crab_folds <- vfold_cv(model_data, v = 5)

spline_rec <- recipe(presence ~ ., data = model_data) %>% 
  step_ns(covars, deg_free = tune("df"))

gam_pars <- gen_additive_mod(adjust_deg_free = tune()) %>% 
  set_engine("mgcv") %>% 
  set_mode("regression") 

spline_grid <- expand.grid(df = 1:5)

gam_simple_wf <- workflow() %>% 
  add_variables(outcomes = presence, predictors = covars) %>% 
  add_model(gam_pars, formula = as.formula(gam_formula))

spline_res <- tune_grid(gam_simple_wf, crab_folds, grid = spline_grid)

%>% 
  fit(data = model_data) %>% 
  add_case_weights(weights) #%>%
  # extract_fit_engine()



gam_simple_wf %>% 
  workflow_map(resamples = crab_folds, grid = 10,
               metrics = metric_set(rmse), verbose = T)


gam_pred <- gam_simple_wf %>%
  predict(mod_match_obs_split$baked_test %>% 
            select(all_of(covars) | "presence"), type = "response") %>%
  as.vector() %>% 
  bind_cols(mod_match_obs_split$baked_test) %>% 
  rename("pred"="...1")

gam_pred %>% 
  roc_auc(presence, pred)#, case_weights = weights)


gam_sel <- gen_additive_mod(select_features = tune(), adjust_deg_free = tune()) %>% 
  set_engine("mgcv") %>% 
  set_mode("regression")

gam_sel_wf <- workflow() %>% 
  add_variables(outcomes = presence, predictors = covars) %>% 
  add_model(gam_pars, formula = as.formula(gam_formula))



gam_sel %>% 
  workflow
  tune_grid(resamples = crab_folds)

%>% 
  fit(data = model_data) %>% 
  add_case_weights(weights) %>% 
  extract_fit_engine()


gam_res <- 


show_best(gam_res, metric = "rmse")
```


